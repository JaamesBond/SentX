# ARCH-002: Pyramid of Pain L1–L5 Integration

| Field | Value |
|-------|-------|
| **Change ID** | ARCH-002 |
| **Date** | 2026-02-20 |
| **Agent** | Master Architect |
| **Status** | Complete |
| **Reviewed By** | N/A (architectural change, human-directed) |
| **Security Cleared** | N/A (documentation only) |

---

## Context

Following the v3.0 architectural revision (ARCH-001), the human directed reinstatement of the Pyramid of Pain framework at Levels 1–5 only. Level 6 (TTPs — Tactics, Techniques & Procedures) is explicitly out-of-scope for the Pyramid of Pain and must not be touched. All existing detection capabilities were mapped to the appropriate Pyramid level (L1–L5).

---

## Pyramid of Pain Scope Decision

| Level | Name | In Scope |
|-------|------|----------|
| L1 | Hash Values | ✅ Yes |
| L2 | IP Addresses | ✅ Yes |
| L3 | Domain Names | ✅ Yes |
| L4 | Network/Host Artifacts | ✅ Yes |
| L5 | Tools | ✅ Yes |
| L6 | TTPs (Techniques & Procedures) | ❌ No — MITRE ATT&CK for ICS only |

---

## Changes Made

| File | Action | Purpose |
|------|--------|---------|
| `docs/TECHNICAL-ARCHITECTURE.md` | Updated | Section 1.3 added (Pyramid L1–L5 mapping); Lambda Stage 6 updated for L1–L5 tagging; `enrich_event()` `RULE_TO_PYRAMID_LEVEL` dict added; dashboard updated with Pyramid Heatmap view; Performance Targets updated |
| `docs/EXECUTION-PLAN.md` | Updated | Phase Overview table references L1–L5 per phase; Week 22 has 5 Pyramid-level red team scenarios (L1–L5); deliverables updated to 5/5; Success Criteria include per-level checkboxes |
| `docs/course-alignment-matrix.md` | Updated | IoC section renamed to "Pyramid of Pain (L1–L5) + MITRE ATT&CK Coverage"; table columns show Pyramid levels; TTPs row explicitly marked as outside Pyramid scope; checklist and summary updated |

---

## Pyramid Level → Detection Mapping

| Pyramid Level | Detection Rules | Lambda Tag |
|---------------|----------------|------------|
| L1 Hash Values | `wazuh_fim_hash`, `virustotal_match`, `zeek_files_hash` | `pyramid_level: L1` |
| L2 IP Addresses | `suricata_ip_rep`, `zeek_chinese_ip`, `zeek_c2_beacon` | `pyramid_level: L2` |
| L3 Domain Names | `zeek_dga_domain`, `suricata_cn_domain` | `pyramid_level: L3` |
| L4 Artifacts | `zeek_ja3_match`, `zeek_modbus_fc`, `zeek_opcua_browse`, `wazuh_fim_registry`, `sysmon_file_drop` | `pyramid_level: L4` |
| L5 Tools | `wazuh_mimikatz`, `wazuh_netcat`, `sigma_tool_match`, `wazuh_psexec`, `zeek_ja3_cobalt` | `pyramid_level: L5` |
| L6 TTPs | *(Not assigned — out of Pyramid scope)* | `mitre_technique: T####` only |

---

## Week 22 Red Team Scenarios (Updated)

| Day | Scenario | Pyramid Level Validated |
|-----|----------|------------------------|
| Monday | Drop malicious binary (known SHA-256) → Wazuh FIM + VirusTotal | L1 Hash Values |
| Tuesday | APT41 C2 IP connection → Zeek + Suricata + CTI enrichment | L2 IP Addresses |
| Wednesday | DGA domain queries (entropy > 3.5) → `dga-detection.zeek` | L3 Domain Names |
| Thursday | Cobalt Strike JA3 + Modbus FC16 write → artifact detectors | L4 Artifacts |
| Friday AM | Mimikatz execution → Wazuh process monitoring + Sigma | L5 Tools |

---

## Verification

- [x] All 5 Pyramid levels (L1–L5) have at least 2 detection rules mapped
- [x] L6 TTPs explicitly marked out-of-scope in all documents
- [x] Lambda `enrich_event()` code assigns `pyramid_level` tag for all L1–L5 rules
- [x] Week 22 deliverables updated: 5/5 scenarios (one per Pyramid level)
- [x] Course alignment matrix preserves 12/12 IoC category coverage (TTPs still covered via MITRE ATT&CK)
- [x] Dashboard Pyramid Heatmap shows L1–L5 only (no L6 column)

---

## For Other Agents

- All detection rules MUST include a `pyramid_level` tag (L1–L5) or explicitly note "L6 — out of Pyramid scope"
- The `RULE_TO_PYRAMID_LEVEL` dict in `enrich_event()` is the authoritative mapping
- Dashboard Pyramid Heatmap: 5 columns (L1–L5), no L6
- MITRE ATT&CK technique IDs are still applied to all alerts via `mitre_technique` tag (independent of Pyramid)

---

## Related

- See `docs/TECHNICAL-ARCHITECTURE.md` v3.0 Section 1.3 for Pyramid detection table
- See `docs/EXECUTION-PLAN.md` Phase 7 for Pyramid-level red team scenarios
- See ARCH-001 for the preceding v3.0 architectural revision
